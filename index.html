<!doctype html>
<html>
<head>
	<title>Three.js - Game</title>
	<meta charset="utf-8">
	<style>
		body {
			margin: 0;
			padding: 0;
			overflow: hidden;
		}
	</style>

	<script type="text/javascript" src="engine/js/RequestAnimationFrame.js"></script>
	<script type="text/javascript" src="engine/build/Three.js"></script>
	<script type="text/javascript" src="engine/js/Stats.js"></script>
	<script type="text/javascript" src="engine/js/socket.io.js"></script>
	<script src="engine/js/Detector.js"></script>
	<script type="text/javascript">
		//Тест
		var Socket = new io.connect('http://' + window.location.host+':8001');
		var SCREEN_WIDTH = window.innerWidth;
		var SCREEN_HEIGHT = window.innerHeight,
		camera,
		projector,
		scene,
		renderer,
		mesh,
		animOffset = 30,
		walking = false,
		stats;
		
		var object;
		var test;

		function initialize() {
			if(!getCookie('user_game_id'))
			{
				setCookie('user_game_id',Math.floor(Math.random(1000) * 1000))
			}
			Socket.on('connect',function()
			{
				Socket.emit('auth',{auth_key:getCookie('user_game_id')},function(responce){
					console.log(responce);
					var r=responce.list[getCookie('user_game_id')];
					test.position.x=r.position.x;
					test.position.y=r.position.y;
					test.position.z=r.position.z;
					// test.direction=r.direction;
					// test.speed=r.speed;
				});
			})
			Socket.on('message',function(message){
				console.log("message",message);
				switch (message.action)
				{
					case 'auth':
						Socket.send(getCookie('user_game_id')+message.key);
					break;
					case 'speed':
						test.speed=message.speed;
					break;
				}
			});

			// Socket.send('tra ta ta');


			container = document.createElement( 'div' );
			document.body.appendChild( container );
			
			scene = new THREE.Scene();

			camera = new THREE.PerspectiveCamera( 90,  window.innerWidth / window.innerHeight, 1, 10000 );
			scene.add( camera );
			
			test=new mObject("./models/space/model.js"
							,{
								translation:[-14.3,-8.5,0]
								,fscale:[3,3,3]
								,direction:[0,0,-1]
								,up:[0,1,0]
							});

			light1 = new THREE.PointLight( 0xff0040, 2, 50 );
			scene.add( light1 );

			object = new THREE.AxisHelper();
			object.position.set( 0, 0, 0 );
			object.scale.x = object.scale.y = object.scale.z = 0.1;
			scene.add( object );

			// Append stats
			stats = new Stats();
			stats.domElement.style.position = 'absolute';
			stats.domElement.style.top = '0px';
			document.body.appendChild( stats.domElement );
			
			renderer = new THREE.WebGLRenderer( { antialias: true, clearColor: 0xe3e3e3, clearAlpha: 1 } );
			renderer.setSize( SCREEN_WIDTH, SCREEN_HEIGHT );
			renderer.domElement.style.position = "relative";
			container.appendChild( renderer.domElement );

			document.addEventListener( 'keydown', onDocumentKeyDown, false );
			//document.addEventListener( 'mousemove', onDocumentMouseMove, false );
			animate();
		}
		function onDocumentMouseMove(e)
		{
			//console.log(e);
			var deltaX=SCREEN_WIDTH/2-e.x;
			var deltaY=SCREEN_HEIGHT/2-e.y;

			test.rotateUp(deltaY/1000);
			test.rotateRight(deltaX/1000);
		}
		function onDocumentKeyDown(e)
		{
		switch(e.keyCode)
		{
			case 87:
				var sp=test.speed+0.1;
				Socket.emit('move',{speed:sp});
				/*
,function(dir){
					console.log(dir);
				}
				*/
			break;
			case 83:
				var sp=test.speed-0.1;
				Socket.emit('move',{speed:sp});
			break;
			case 65:
				test.rotateRight(0.01);
			break;
			case 68:
				test.rotateRight(-0.01);
			break;
			case 32:
				Socket.emit('ping','space',function(X,Y){
					console.log(X);
				})
			break;
		}
		
		}
		function animate() 
		{
			requestAnimationFrame( animate );
			render();
			test.update();
			stats.update();
		}
		function render() 
		{
 			/*camera.lookAt( 
 						 test.direction.x*20+test.position.x
 						,test.direction.y*20+test.position.y
 						,test.direction.z*20+test.position.z );
 			camera.position.set( 
 						 test.position.x-test.direction.x*30
 						,test.position.y+9-test.direction.y*30
 						,test.position.z-test.direction.z*30);*/
		 /*	console.log( camera.position
		 				,{x:test.direction.x*30+test.position.x
 						,y:test.direction.y*30+test.position.y
 						,z:test.direction.z*30+test.position.z}
 						,test.position
		 				,test.direction
		 				);				*/	
			camera.lookAt( 
 						 0
 						,0
 						,-30 );
 			camera.position.set( 
 						 0
 						,9
 						,22);
			light1.position.set(
			  			 test.direction.x+test.position.x
 						,test.direction.y+test.position.y+15
 						,test.direction.z+test.position.z
			  );
			renderer.render( scene, camera );
		}
	var mObject=function(model_name,options)
	{
		var me=this;
		me.deltaR=Math.PI*2;
		me.deltaU=0;
		me.baseObject=new THREE.Object3D();
		me.baseObject.useQuaternion=true;
		scene.add(me.baseObject);
		
		me.position=new THREE.Vector3();
		
		me.baseObject.position=me.position;
		
		
		me.isLoaded=false;
		
		me.fposition=new THREE.Vector3();
		if(typeof options.translation!="undefined")
		{
			me.fposition.x=options.translation[0];
			me.fposition.y=options.translation[1];
			me.fposition.z=options.translation[2];
		}
		me.fscale=new THREE.Vector3();
		
		if(typeof options.fscale!="undefined")
		{
			me.fscale.x=options.fscale[0];
			me.fscale.y=options.fscale[1];
			me.fscale.z=options.fscale[2];
		}
		else
		{
			me.fscale.x=
			me.fscale.y=
			me.fscale.z=1;
		}
		
		
		me.speed=0;
		
		me.direction=new THREE.Vector3();
		me.base_direction=new THREE.Vector3();
		if(typeof options.direction!="undefined")
		{
			me.direction.x=options.direction[0];
			me.direction.y=options.direction[1];
			me.direction.z=options.direction[2];
			
			me.base_direction.x=options.direction[0];
			me.base_direction.y=options.direction[1];
			me.base_direction.z=options.direction[2];
			
		}
		else
		{
			me.direction.x=1;
			me.base_direction.x=1;
		}
		
		me.up=new THREE.Vector3();
		me.base_up=new THREE.Vector3();
		me.right=new THREE.Vector3();
		me.base_right=new THREE.Vector3();
		if(typeof options.up!="undefined")
		{
			me.up.x=options.up[0];
			me.up.y=options.up[1];
			me.up.z=options.up[2];

			me.base_up.x=options.up[0];
			me.base_up.y=options.up[1];
			me.base_up.z=options.up[2];
		}
		else
		{
			me.up.z=1;
			me.base_up.z=1;
		}
		
		
		me.right.cross(me.up,me.direction);
		me.base_right.cross(me.up,me.direction);

		me.rotateTOR=0;
		me.rotateTOU=0;	
		var loader=new THREE.JSONLoader();
		loader.load( model_name, createScene);
		
		function createScene(geometry)
		{
			var model = new THREE.Mesh( geometry, new THREE.MeshFaceMaterial() );
			model.scale=me.fscale;
			model.position=me.fposition;
			model.rotate=me.frotate;
			
			me.baseObject.add(model);
			me.isLoaded=true;
		}
		
		

		me.update=function()
		{
			me.position.x+=me.direction.x*me.speed;
			me.position.y+=me.direction.y*me.speed;
			me.position.z+=me.direction.z*me.speed;
			me.deltaR+=me.rotateTOR;
			me.deltaU+=me.rotateTOU;
			if(me.deltaR>4*Math.PI)me.deltaR=0;
			if(me.deltaU>4*Math.PI)me.deltaU=0;
			if(me.deltaR<0)me.deltaR=4*Math.PI;
			if(me.deltaU<0)me.deltaU=4*Math.PI;
			update_rotate_position();
			//console.log(me.deltaR*180/Math.PI,me.deltaU*180/Math.PI);
		}
		
		me.rotateRight=function(delta)
		{
			me.rotateTOR=delta;

		}
		
		me.rotateUp=function(delta)
		{
			me.rotateTOU=delta;
		}

		function update_rotate_position()
		{

			var q1 = new THREE.Quaternion();
			q1.setFromAxisAngle( me.right, me.deltaU );
			
			q1.multiplyVector3(me.base_direction, me.direction);

			 // me.up.cross(me.direction,me.right);


			var q2 = new THREE.Quaternion();
			q2.setFromAxisAngle( me.up, me.deltaR );
			
			// q2.multiplyVector3(me.direction,me.direction);

			// me.right.cross(me.up,me.direction);

			var q3 = new THREE.Quaternion();
			q3.multiply(q1,q2);

			me.baseObject.quaternion.copy(q3);

			 q3.multiplyVector3( me.base_direction, me.direction );
			 q3.multiplyVector3( me.base_up, me.up );
			// q3.multiplyVector3( me.base_right, me.right );
			 me.right.cross(me.up,me.direction);
			// console.log(me.direction.x,me.direction.y,me.direction.z,me.up.x,me.up.y,me.up.z,me.right.x,me.right.y,me.right.z);
		}
	}




	//COOKIES WORK

	function setCookie (name, value, expires, path, domain, secure) {
      document.cookie = name + "=" + escape(value) +
        ((expires) ? "; expires=" + expires : "") +
        ((path) ? "; path=" + path : "") +
        ((domain) ? "; domain=" + domain : "") +
        ((secure) ? "; secure" : "");
	}

	function getCookie(name) {
		var cookie = " " + document.cookie;
		var search = " " + name + "=";
		var setStr = null;
		var offset = 0;
		var end = 0;
		if (cookie.length > 0) {
			offset = cookie.indexOf(search);
			if (offset != -1) {
				offset += search.length;
				end = cookie.indexOf(";", offset)
				if (end == -1) {
					end = cookie.length;
				}
				setStr = unescape(cookie.substring(offset, end));
			}
		}
		return(setStr);
	}
	// END COOKIES WORK
	</script>
</head>
<body>
	<script type="text/javascript">
		initialize();
		//animate();
	</script>
</body>
</html>